name: Build App-1 Stage
on:
  push:
    branches:
      - 'dev'
      - 'stage'
  workflow_dispatch:

env:
  ORG: ${{ github.repository_owner }}
  ENVIRONMENT: dev

permissions:
  contents: read
  packages: write 

jobs:
  timestamp:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.timestamp.outputs.version }}
    steps:
      - name: Generate timestamp
        id: timestamp
        run: |
          echo "version=$(date +%Y-%m-%d-%H-%M-%S)" >> $GITHUB_OUTPUT

      - name: Show version
        run: echo "Version is ${{ steps.timestamp.outputs.version }}"

  trigger-reusable-workflow:
    needs: timestamp
    uses: azure-terraform-infra/release-rollback-repo/.github/workflows/build-images.yaml@main
    with:
      version: ${{ needs.timestamp.outputs.version }}
      app-name: ${{ github.event.repository.name }}
      environment: "dev"
    secrets: inherit

  trigger-deploy-chart-workflow:
    needs: [trigger-reusable-workflow, timestamp]
    name: Deploy Release
    runs-on: ubuntu-latest
    steps:
      - name: Trigger the App Charts runner
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ env.ORG }}/app-charts
          event-type: charts-deployment-trigger
          client-payload: |
            {
              "environment": "${{ env.ENVIRONMENT }}",
              "version": ${{ needs.timestamp.outputs.version }}
            }

      - name: Wait for workflow to complete
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "Waiting for Charts CI/CD Pipeline workflow to start..."
          sleep 15
          
          TIMEOUT=1800
          ELAPSED=0
          INTERVAL=15
          FOUND=false
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Get recent workflow runs
            RUNS=$(gh run list \
              --repo ${{ env.ORG }}/app-charts \
              --workflow "Charts CI/CD Pipeline" \
              --limit 5 \
              --json status,conclusion,createdAt,databaseId)
            
            # Find the most recent run created after this step started
            LATEST_RUN=$(echo "$RUNS" | jq -r '.[0]')
            
            if [ "$LATEST_RUN" != "null" ] && [ "$LATEST_RUN" != "" ]; then
              FOUND=true
              STATUS=$(echo "$LATEST_RUN" | jq -r '.status')
              CONCLUSION=$(echo "$LATEST_RUN" | jq -r '.conclusion')
              RUN_ID=$(echo "$LATEST_RUN" | jq -r '.databaseId')
              
              echo "[${ELAPSED}s] Workflow run #$RUN_ID - Status: $STATUS, Conclusion: $CONCLUSION"
              
              if [ "$STATUS" == "completed" ]; then
                if [ "$CONCLUSION" == "success" ]; then
                  echo "✅ Workflow completed successfully"
                  exit 0
                else
                  echo "❌ Workflow failed with conclusion: $CONCLUSION"
                  exit 1
                fi
              fi
            else
              echo "[${ELAPSED}s] Waiting for workflow to start..."
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ "$FOUND" == "false" ]; then
            echo "❌ No workflow run found"
          else
            echo "❌ Timeout waiting for workflow to complete"
          fi
          exit 1